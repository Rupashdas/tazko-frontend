<script setup>
import BaseCard from '@/components/ui/BaseCard.vue'
import AvatarCropModal from "@/components/profile/AvatarCropModal.vue";
import { useAuthStore } from '@/stores/auth'
import { useRouter } from 'vue-router'
import { useToast } from '@/utils/toast'
import { ref, onMounted, computed } from 'vue'

const auth = useAuthStore()
const router = useRouter()

const showModal = ref(false)

const avatarUrl = computed(() => {
	return auth.user?.avatar ? auth.user.avatar: null
})

// Form fields
const firstName = ref('')
const lastName = ref('')
const email = ref('')
const title = ref('')
const phone = ref('')
const bio = ref('')
const location = ref('')
const password = ref('')
const confirmPassword = ref('')


const loading = ref(false)
const { successToast, errorToast } = useToast()

// Load user data
onMounted(async () => {
    if (!auth.authChecked) {
        await auth.fetchUser()
    }

    if (!auth.isLoggedIn) {
        await router.push('/login')
        return
    }

    if (auth.user) {
        const nameParts = auth.user.name?.split(' ') || []
        firstName.value = nameParts[0] || ''
        lastName.value = nameParts.slice(1).join(' ') || ''
        email.value = auth.user.email || ''
        title.value = auth.user.title || ''
        phone.value = auth.user.phone || ''
        bio.value = auth.user.bio || ''
        location.value = auth.user.location || ''
    }
})


// Submit handler
const handleProfileSave = async () => {

    if (!firstName.value || !lastName.value || !email.value) {
        errorToast('Please fill in all required fields.')
        return
    }

    if (password.value && password.value !== confirmPassword.value) {
        errorToast('Passwords do not match.')
        return
    }

    loading.value = true

    const formData = new FormData()

    formData.append('name', `${firstName.value} ${lastName.value}`)
    formData.append('email', email.value)
    formData.append('title', title.value || '')
    formData.append('phone', phone.value || '')
    formData.append('bio', bio.value || '')
    formData.append('location', location.value || '')

    if (password.value) {
        formData.append('password', password.value)
        formData.append('password_confirmation', confirmPassword.value)
    }

    const response = await auth.updateProfile(formData)

    if (response.success) {
        successToast(response.message)
        password.value = ''
        confirmPassword.value = ''
    } else {
        if (response.errors && Object.keys(response.errors).length > 0) {
            Object.values(response.errors).flat().forEach(message => {
                errorToast(message)
            })
        } else if (response.message) {
            errorToast(response.message)
        } else {
            errorToast('Something went wrong')
        }
    }

    loading.value = false
}

</script>

<template>
    <base-card maxWidth="max-w-3xl" marginTop="mt-30">
        <div class="relative -mt-30">
            <div class="text-center">
                <img v-if="avatarUrl" :src="avatarUrl"
	                class="w-60 h-60 object-cover rounded-full border-tazko-blue border-3 mx-auto"/>
                <div v-else class="w-60 h-60 mx-auto block">
                    <v-icon class="w-60 h-60 bg-white rounded-full shadow-md shadow-tazko-blue/10"
                        name="la-user-circle-solid" />
                </div>

                <button @click="showModal = true"
	                class="border px-4 py-2 border-tazko-blue rounded-3xl mt-5 cursor-pointer text-xs font-bold text-tazko-blue hover:bg-tazko-blue/10 transition">Change your avatar</button>
	            <Teleport to="body">
	                <AvatarCropModal :show="showModal" @close="showModal = false"/>
	            </Teleport>
            </div>
            <div class="mt-8">
                <form action="#" class="space-y-4" @submit.prevent="handleProfileSave">
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium text-sm">First Name <span class="text-red-500">*</span></label>
                        <input v-model="firstName" type="text" placeholder="Enter your first name" class="input-field"/>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium text-sm">Last Name <span
                            class="text-red-500">*</span></label>
                        <input v-model="lastName" type="text" placeholder="Enter your first name" class="input-field"/>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium text-sm">Email <span
                            class="text-red-500">*</span></label>
                        <input v-model="email" type="text" placeholder="Enter your email address"
                            class="input-field"/>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium text-sm">Title</label>
                        <input v-model="title" type="text" placeholder="e.g. Web developer"
                            class="input-field"/>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium text-sm">Phone</label>
                        <input v-model="phone" type="text" placeholder="Enter phone number"
                            class="input-field"/>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium text-sm">Short bio or current status</label>
                        <textarea v-model="bio" type="text" placeholder="e.g. Beleive in quality" rows="4"
                            class="input-field"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium text-sm">Location</label>
                        <input v-model="location" type="text" placeholder="Enter your location"
                            class="input-field"/>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium text-sm">Password</label>
                        <input v-model="password" type="password" placeholder="Enter your password"
                            class="input-field"/>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium text-sm">Confirm Password</label>
                        <input v-model="confirmPassword" type="password" placeholder="Enter your password again"
                            class="input-field"/>
                    </div>
                    <button type="submit" class="tazko-btn w-full" :disabled="loading">
                        {{ loading ? 'Saving...' : 'Save Changes' }}
                    </button>
                </form>
            </div>
        </div>
    </base-card>
</template>